<!DOCTYPE html>
<html>

<head>
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <meta charset=â€œUTF-8â€>
    <style>
        body {
            background: rgb(27, 30, 31);
        }

        /*  CSS^Flash Button */
        #flashbutton {

            background-color: rgb(4, 91, 91);
            display: block;
            width: 65px;
            height: 65px;
            border-radius: 15px;
            font-family: Arial;
            font-size: 3rem;
            margin-top: 10px;
            margin-bottom: 10px;
        }

        /*  CSS^Red Slider */

        .redslider {
            margin-top: 20px;
            -webkit-appearance: none;
            width: 50%;
            height: 15px;
            background: #000;
            outline: none;
            border: 5px solid rgb(255, 0, 4);
            border-radius: 8px;
        }


        /* for chrome/safari */
        .redslider::-webkit-slider-thumb {
            -webkit-appearance: none;
            appearance: none;
            width: 40px;
            height: 40px;
            background: #000;
            cursor: pointer;
            border: 5px solid rgb(255, 0, 0);
            border-radius: 20px;
        }

        /* for firefox */
        .redslider::-moz-range-thumb {
            width: 40px;
            height: 60px;
            background: #000;
            cursor: pointer;
            border: 5px solid rgb(255, 0, 0);
            border-radius: 15px;
        }

        /*  CSS^ Green Slider */

        .greenslider {
            margin-top: 20px;
            -webkit-appearance: none;
            width: 50%;
            height: 15px;
            background: #000;
            outline: none;
            border: 5px solid lawngreen;
            border-radius: 8px;
        }


        /* for chrome/safari */
        .greenslider::-webkit-slider-thumb {
            -webkit-appearance: none;
            appearance: none;
            width: 40px;
            height: 40px;
            background: #000;
            cursor: pointer;
            border: 5px solid lawngreen;
            border-radius: 20px;
        }

        /* for firefox */
        .greenslider::-moz-range-thumb {
            width: 40px;
            height: 60px;
            background: #000;
            cursor: pointer;
            border: 5px solid lawngreen;
            border-radius: 15px;
        }

        /*  CSS^ Blue Slider */

        .blueslider {
            margin-top: 20px;
            margin-bottom: 10px;
            -webkit-appearance: none;
            width: 50%;
            height: 15px;
            background: #000;
            outline: none;
            border: 5px solid rgb(0, 0, 255);
            border-radius: 8px;
        }


        /* for chrome/safari */
        .blueslider::-webkit-slider-thumb {
            -webkit-appearance: none;
            appearance: none;
            width: 40px;
            height: 40px;
            background: #000;
            cursor: pointer;
            border: 5px solid rgb(0, 0, 255);
            border-radius: 20px;
        }

        /* for firefox */
        .blueslider::-moz-range-thumb {
            width: 40px;
            height: 60px;
            background: #000;
            cursor: pointer;
            border: 5px solid rgb(0, 0, 255);
            border-radius: 15px;
        }

        .unitid {

            /* CSS^unitid */
            font-weight: 500;
            text-transform: uppercase;
            color: rgb(68, 146, 248);
            font-family: Arial;
            font-size: 1.3rem;
            text-align: center;
            display: block;
            padding-left: 10px;
            padding-right: 10px;
            line-height: 22px;
            letter-spacing: 1.5px;
        }

        .location {

            /* CSS^location */
            margin-bottom: 10px;
            line-height: 25px;
            display: block;
            font-weight: 400;
            text-transform: uppercase;
            color: rgb(22, 188, 230);
            font-size: 1rem;
            font-family: Arial;
            letter-spacing: 1.5px;
        }

        .bulb {
            display: block;
            font-size: 2.5rem;
        }

        .pockets {

            /* CSS^pockets */
            letter-spacing: 1px;
            padding: 5px;
            border: 5px outset rgb(33, 63, 70);
            font-weight: 500;
            text-transform: uppercase;
            color: rgb(211, 211, 39);
            text-align: center;
            display: block;
            font-size: 1.1rem;
            font-family: Arial;
            margin-top: 12px;
        }

        .rxID {
            letter-spacing: 1.5px;
            color: darkorange;
        }

        .rxtime {
            font-size: 1.1rem;
            letter-spacing: 1.2px;
            color: rgb(216, 119, 0);
        }

        .unitinfo {

            /* CSS^unitinfo */
            margin-top: 10px;
            text-align: center;
            border: 5px outset rgb(33, 67, 70);
            display: block;
            font-weight: 500;
            padding: 10px;
            text-transform: uppercase;
            color: rgb(68, 146, 248);
            font-size: 1.1rem;
            font-family: Arial;
        }

        .uptime {

            /* CSS^uptime */
            margin-top: 10px;
            padding: 5px;
            text-align: center;
            border: 5px outset rgb(33, 67, 70);
            font-weight: 500;
            text-transform: uppercase;
            color: rgb(27, 189, 140);
            display: block;
            font-size: 1rem;
            font-family: Arial;
        }

        .mcus {

            /* CSS^mcus */

            margin-top: 10px;
            padding-left: 40px;
            padding-right: 10px;
            text-align: start;
            text-transform: uppercase;

            padding-top: 10px;
            padding-bottom: 10px;
            font-size: 1rem;
            letter-spacing: 1px;
            font-family: Arial;
            border: 5px outset rgb(33, 67, 70);

        }

        .mculist {

            /* CSS^MCU List */
            padding-bottom: 10px;
            color: darkkhaki;
            white-space: pre-line;
            text-align: left;

        }

        .events {

            /* CSS^events */
            border: 5px outset rgb(33, 67, 70);
            list-style-position: inside;
            padding-bottom: 10px;
            color: rgb(120, 116, 114);
            white-space: pre-line;
            text-align: start;
            font-family: Arial;
            padding-top: 10px
        }

        .log {

            /* CSS^log */
            padding-bottom: 10px;
            white-space: pre-line;
            text-align: left;
            text-transform: uppercase;

        }

        .card {

            /* CSS^card */
            text-align: center;
            border: outset 5px rgb(43, 64, 66);
            display: block;
            margin: auto;
            padding: 15px;
            box-shadow: 2px 2px 12px 1px rgba(140, 140, 140, .5)
        }

        .switch {

            /* CSS^Switch */
            position: relative;
            display: block;
            width: 250px;
            height: 52px;
            margin: auto;

        }

        .switch input {
            display: none
        }

        .slider {
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background-color: rgb(243, 188, 188);
            border-radius: 34px
        }

        .slider:before {
            position: absolute;
            content: "";
            height: 22px;
            width: 40px;
            left: 8px;
            bottom: 13px;
            background-color: rgb(15, 108, 131);
            transition: .6s;
            border-radius: 48px
        }

        input:checked+.slider:before {
            transform: translateX(185px);
            border: aqua solid 2px;

        }

        </style </head>
        
        <body>
            <div class='card'>
                <span class='unitid'>garage1<br>1 of 4</span>
                <span class='location'>Light next to water heaters</span>
                
                <span id='unit1'><label class='switch'><input type='checkbox' onchange='toggleCheckbox(this)' id='12' checked><span
                            id='lightcolor' class='slider' style='background-color: rgb(0,186,0)'><span class='bulb'
                                id='bulb'>&#x1F506</span></span></label></span>
                                
                    <input class='redslider' type='range' id='slideRed' min='0' max='255' oninput='updateLightColor()'
                        onchange='updateNeoPixel()' value='0' style='display:inline-block'><input class='greenslider' type='range'
                        id='slideGreen' min='0' max='255' oninput='updateLightColor()' onchange='updateNeoPixel()' value='186'
                        style='display:inline-block'><input class='blueslider' type='range' id='slideBlue' min='0' max='255'
                        oninput='updateLightColor()' onchange='updateNeoPixel()' value='0' style='display:inline-block'><span
                        id='flashbutton' onclick='flashAlert()' style='display:block'>&#x1F6A6</span><span class='pockets'
                        id='traffic'><span id='unitname'>garage1 - 3 of 4</span><br><span id='unitip'>192.168.10.51</span><br><span
                            id='pocketid' class='rxID'>0</span><br><span id='new_command' onchange='newcmdreceived(this)'
                            class='rxID'>alarm2 </span><br><span id='rxtimestamp' class='rxtime'></span></span><span class='uptime'
                        id='localUptime'>3 hours,
                        30 minutes</span>
                <ol id='mculist' class='mcus'></ol><span
                    class='unitinfo'>192.168.10.30<br>50:02:91:67:F9:96<br>BA-1-v1-garage1-1of4-433</span>
                <ol id='unitlog' class='events'></ol>
            </div>
            <script> //JS^Globals

            window.mcuList = [];
            window.browserid = "";
            window.flashRate = 0;
            window.totalEventsInList = 0;

            lerp = function (a, b, u) {
                return (1 - u) * a + u * b;
            }

                ;

            function getRGBValues(str) {
                var vals = str.substring(str.indexOf('(') + 1, str.length - 1).split(', ');

                return {
                    'r': vals[0],
                    'g': vals[1],
                    'b': vals[2]
                }

                    ;
            }

            fade = function (element, property, start, end, duration) {
                var interval = 10;
                var steps = duration / interval;
                var step_u = 1.0 / steps;
                var u = 0.0;

                var theInterval = setInterval(function () {
                    if (u >= 1.0) {
                        clearInterval(theInterval)
                    }

                    var r = parseInt(lerp(start.r, end.r, u));
                    var g = parseInt(lerp(start.g, end.g, u));
                    var b = parseInt(lerp(start.b, end.b, u));
                    var colorname = 'rgb(' + r + ',' + g + ',' + b + ')';
                    el.style.setProperty(property, colorname);
                    u += step_u;
                }

                    , interval);
            }

                ;


            //JS^highlightNewCommand
            function highlightNewCommand(elem) {

                var nc = document.getElementById(elem).innerHTML;
                console.log("New command: " + nc + " highlighted");

                el = document.getElementById(elem); // your element
                property = 'color'; // fading property

                startColor = {
                    r: 255, g: 140, b: 0
                }

                    ; // dark turquoise

                endColor = {
                    r: 255, g: 255, b: 255
                }

                    ; // dark turquoise
                fade(el, 'color', startColor, endColor, 1000);

                // fade back after 2 secs
                setTimeout(function () {
                    fade(el, property, endColor, startColor, 1000);
                }

                    , 2000);



            }

            //JS^flashAlert
            function flashAlert() {

                window.flashRate++;
                updateFlashButton(window.flashrate);

                //JSurl^flashAlert
                var xhr = new XMLHttpRequest();
                xhr.open("GET", "/flashalert?alert=" + window.flashRate + "&browserid=" + window.browserid, true);
                xhr.send();
            }

            //JS^updateFlashButton
            function updateFlashButton() {

                var selector = parseInt(window.flashRate);
                console.log("Updating Flash Button with level: " + selector);

                switch (selector) {

                    case 3:

                        console.log('Red warning light');
                        document.getElementById("flashbutton").innerHTML = "&#x1F46E";
                        document.getElementById("flashbutton").style.background = "red";
                        break;

                    case 2:

                        console.log('Yellow warning light');
                        document.getElementById("flashbutton").innerHTML = "&#x1F526";
                        document.getElementById("flashbutton").style.background = "yellow";
                        break;

                    case 1:

                        console.log('Green warning light');
                        document.getElementById("flashbutton").innerHTML = "&#x1F4A1";
                        document.getElementById("flashbutton").style.background = "green"
                        break;

                    default:

                        console.log("Warning light Off");
                        window.flashRate = 0;
                        document.getElementById("flashbutton").innerHTML = "&#x1F6A6";
                        document.getElementById("flashbutton").style.background = "darkcyan";
                }
            }


            // JS^Browser ID
            function makeid(length) {
                var result = '';
                var characters = 'ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789';
                var charactersLength = characters.length;

                for (var i = 0; i < length; i++) {
                    result += characters.charAt(Math.floor(Math.random() * charactersLength));
                }

                window.browserid = result;
                console.log("Browser ID: " + window.browserid);

            }

            //JS^RGB Sliders
            function updateLightColor() {

                console.log("Updating Light Switch Color");
                var r = document.getElementById('slideRed').value;
                var g = document.getElementById('slideGreen').value;
                var b = document.getElementById('slideBlue').value;
                document.getElementById('lightcolor').style.backgroundColor = "rgb(" + r + "," + g + "," + b + ")";
            }

            function relayControl(element) {

                //JSurl^Relay Control
                var xhr = new XMLHttpRequest();

                if (element.checked) {
                    xhr.open("GET", "/relayupdate?relay=" + element.id + "&state=1", true);
                    light = document.getElementById('bulb');
                    light.innerHTML = "&#x1F506";
                    console.log("MCU Relay on remote");
                }

                else {
                    xhr.open("GET", "/relayupdate?relay=" + element.id + "&state=0", true);
                    light = document.getElementById('bulb');
                    light.innerHTML = "&#x23F1";
                    console.log("MCU Relay off remote");
                }

                xhr.send();

            }

            function updateNeoPixel() {

                //JSurl^ NeopPixel update

                var r = document.getElementById('slideRed').value;
                var g = document.getElementById('slideGreen').value;
                var b = document.getElementById('slideBlue').value;
                var webid = window.browserid;

                var xhr = new XMLHttpRequest();
                xhr.open("GET", "/neopixel?red=" + r + "&green=" + g + "&blue=" + b + "&browserid=" + webid, true);
                xhr.send();

                if (r == 0 && g == 0 && b == 0) {

                    document.getElementById('bulb').innerHTML = "&#x23F1"
                }

                else {

                    document.getElementById('bulb').innerHTML = "&#x1F506";

                }

                console.log("neo MCU: red = " + r + " - " + " - green = " + g + " - blue = " + b);

            }

            function toggleCheckbox(element) {

                //JSurl^toggleCheckBox
                var xhr = new XMLHttpRequest();

                if (element.checked) {

                    xhr.open("GET", "/relayupdate?relay=" + element.id + "&state=1", true);

                    light = document.getElementById('bulb');
                    light.innerHTML = "&#x1F506";
                    console.log("MCU Relay on - " + element.checked);

                    document.getElementById("slideRed").style.display = "inline-block";
                    document.getElementById("slideGreen").style.display = "inline-block";
                    document.getElementById("slideBlue").style.display = "inline-block";
                    document.getElementById("flashbutton").style.display = "block";



                }

                else {

                    xhr.open("GET", "/relayupdate?relay=" + element.id + "&state=0", true);

                    light = document.getElementById('bulb');
                    light.innerHTML = "&#x23F1";
                    console.log("MCU Relay off - " + element.checked);

                    document.getElementById("slideRed").style.display = "none";
                    document.getElementById("slideGreen").style.display = "none";
                    document.getElementById("slideBlue").style.display = "none";
                    document.getElementById("flashbutton").style.display = "none";

                }

                xhr.send();
            }

            function sortList(ol) {

                //JS^sortList
                var checkListCount = document.getElementById("mculist").getElementsByTagName("li").length;

                if (checkListCount == window.totalUnitsInList) {
                    console.log("MCU List NOT sorted");
                    return;
                }

                var ol = document.getElementById(ol);

                Array.from(ol.getElementsByTagName("LI")).sort((a, b) => a.textContent.localeCompare(b.textContent)).forEach(li => ol.appendChild(li));
                console.log("MCU List sorted");
            }

            function addMCU(ol, unitid, mcuid) {

                //JS^addMCU
                var mcuList = document.getElementById(ol);
                var entry = document.createElement('li');
                entry.setAttribute('id', 'mcu' + mcuid);
                entry.setAttribute('class', 'mculist');
                entry.appendChild(document.createTextNode(unitid + ' - ' + getDateTime()));
                mcuList.appendChild(entry);

            }

            function addLog(ol, unitname, ip, mac, evtime, command, pocketid, eventnumber) {

                //JS^addLog
                var eventList = document.getElementById(ol);
                var entry = document.createElement('li');
                entry.setAttribute('class', 'log');

                entry.appendChild(document.createTextNode(unitname + '\r\n' + ip + '\r\n' + mac + '\r\n' + evtime + '\r\n' + command + ' ->' + pocketid + ' - ' + (eventnumber + 1)));
                eventList.insertBefore(entry, eventList.firstChild);

            }

            function getDateTime() {

                //JS^getDateTime
                var currentdate = new Date();
                var datetime = (currentdate.getMonth() + 1 + "/"
                    + currentdate.getDate()) + "/"
                    + currentdate.getFullYear() + " at "
                    + currentdate.getHours() + ":"
                    + currentdate.getMinutes() + ":"
                    + currentdate.getSeconds();
                return datetime;

            }


            //JS^EventSource
            if (! !window.EventSource) {

                var source = new EventSource('/events');

                source.addEventListener('open', function (e) {
                    console.log("Events Connected");
                }

                    , false);

                source.addEventListener('error', function (e) {
                    if (e.target.readyState != EventSource.OPEN) {
                        console.log("Events Disconnected");
                    }
                }

                    , false);

                source.addEventListener('message', function (e) {
                    console.log("message", e.data);
                }

                    , false);


                source.addEventListener('updatetime', function (e) {
                    // JSui^UpdateTime
                    console.log("Updating local up time", e.data);
                    var obj = JSON.parse(e.data);
                    document.getElementById("localUptime").innerHTML = obj.localTime;

                }

                    , false);

                source.addEventListener('flashalert', function (e) {

                    // JSui^flashAlert
                    var obj = JSON.parse(e.data);

                    if (window.browserid == obj.browserid) {

                        console.log("Duplicate browser id detected - Flash UI update cancelled");
                        return;
                    }

                    window.flashRate = obj.flashLevel;
                    console.log("Flash alert received - alert level = " + window.flashRate);
                    updateFlashButton();


                }

                    , false);

                source.addEventListener('rgbupdate', function (e) {

                    // JSui^Update RGB UI

                    var obj = JSON.parse(e.data);

                    console.log("Updating RGB Controls" + "\n" + "Local ID: " + window.browserid + "\n" + "ID Received: " + obj.browserid + "\n", e.data);

                    if (window.browserid == obj.browserid) {

                        console.log("Duplicate browser id detected - RGB UI update cancelled");
                        return;
                    }

                    var relayState = obj.relaystate var power = document.getElementById(obj.relaypin) if (relayState == 1) {

                        console.log("Switch relay pin " + obj.relaypin + " to " + relayState);
                        power.checked = true;
                        document.getElementById("slideRed").style.display = "inline-block";
                        document.getElementById("slideGreen").style.display = "inline-block";
                        document.getElementById("slideBlue").style.display = "inline-block";
                        document.getElementById('bulb').innerHTML = "&#x1F506";
                        document.getElementById("flashbutton").style.display = "block";



                    }

                    else {

                        console.log("Switch relay pin " + obj.relaypin + " to " + relayState);
                        document.getElementById("slideRed").style.display = "none";
                        document.getElementById("slideGreen").style.display = "none";
                        document.getElementById("slideBlue").style.display = "none";
                        document.getElementById("flashbutton").style.display = "none";

                        power.checked = false;
                        document.getElementById('bulb').innerHTML = "&#x23F1"

                    }

                    console.log("Updating RGB UI");

                    if (obj.red == 0 && obj.green == 0 && obj.blue == 0) {

                        document.getElementById('bulb').innerHTML = "&#x23F1"
                    }

                    document.getElementById("slideRed").value = obj.red;
                    document.getElementById("slideGreen").value = obj.green;
                    document.getElementById("slideBlue").value = obj.blue;

                    updateLightColor();


                }

                    , false);


                source.addEventListener('new_command', function (e) {

                    //JSui^new_command
                    console.log("new_command", e.data);
                    var obj = JSON.parse(e.data);

                    document.getElementById("unitname").innerHTML = obj.unitname;
                    document.getElementById("unitip").innerHTML = obj.ip;
                    document.getElementById("new_command").innerHTML = obj.new_command;
                    document.getElementById("rxtimestamp").innerHTML = getDateTime();
                    document.getElementById("pocketid").innerHTML = obj.pocketid + " - " + obj.msgsize;

                    // Control the Relay Based on the command received
                    if (obj.new_command == 'lightOn') {

                        var inputs = document.getElementsByTagName("input");

                        for (var i = 0; i < inputs.length; i++) {
                            if (inputs[i].type == "checkbox") {
                                inputs[i].checked = true;
                                relayControl(inputs[i]);
                                console.log("Turning relay on command");
                            }
                        }

                    }

                    else if (obj.new_command == 'lightOff') {

                        var inputs = document.getElementsByTagName("input");

                        for (var i = 0; i < inputs.length; i++) {
                            if (inputs[i].type == "checkbox") {
                                inputs[i].checked = false;
                                relayControl(inputs[i]);
                                console.log("Turning relay off command");
                            }
                        }

                    }

                    // JS^Add Log
                    window.totalEventsInList = document.getElementById("unitlog").getElementsByTagName("li").length;
                    console.log('Total events in list: ' + window.totalEventsInList);
                    addLog("unitlog", obj.unitname, obj.ip, obj.mac, getDateTime(), obj.new_command, obj.pocketid + " - " + obj.msgsize, window.totalEventsInList);

                    // Check if the unit is already in the MCU List
                    if (window.mcuList.includes(obj.id)) {

                        console.log('MCU ' + obj.id + ' already exists. Updating instead');
                        document.getElementById('mcu' + obj.id).textContent = obj.unitname + '\r\n' + obj.ip + '\r\n' + obj.uptime + '\r\n' + getDateTime() + '\r\n' + obj.new_command;

                    }

                    else {

                        console.log('Adding MCU ' + obj.id + ' to list');
                        window.mcuList.push(obj.id);
                        addMCU("mculist", obj.unitname, obj.id);
                        sortList("mculist") window.totalUnitsInList = document.getElementById("mculist").getElementsByTagName("li").length;
                        console.log('MCUs added to list: ' + window.totalUnitsInList);

                    }

                    //JS^highlite test
                    highlightNewCommand('new_command');

                }

                    , false);
            }

            //JS^CreateUserID
            window.onload = makeid(10);

        </script></body></html>